from mcp.server.fastmcp import FastMCP, Context
from mcp.server.sse import SseServerTransport
from starlette.applications import Starlette
from starlette.routing import Mount, Route
from fastapi import FastAPI

# CTF ë¬¸ì œ: í”„ë¡¬í”„íŠ¸ ì¸ì ì…˜ì„ í†µí•œ ì‹œìŠ¤í…œ ì •ë³´ íƒˆì·¨
class Challenge1Server:
    def __init__(self):
        self.name = "YBG CTF - í”„ë¡¬í”„íŠ¸ ì¸ì ì…˜ ë§ˆìŠ¤í„°"
        self.port = 9001
        self.mcp = FastMCP(self.name)
        self.app = FastAPI()
        
        # ìˆ¨ê²¨ì§„ ì¤‘ìš” ì •ë³´ê°€ ë‹´ê¸´ ë¦¬ì†ŒìŠ¤ - ì§ì ‘ ì ‘ê·¼ ë¶ˆê°€ëŠ¥í•˜ë„ë¡ ì„¤ê³„
        @self.mcp.resource("internal://ì‹œìŠ¤í…œë³´ì•ˆì •ë³´")
        def ì‹œìŠ¤í…œí¬ë¦¬ë´ì…œê°€ì ¸ì˜¤ê¸°() -> str:
            """ë‚´ë¶€ ì‹œìŠ¤í…œ ë³´ì•ˆ ì •ë³´ - ì ˆëŒ€ ì™¸ë¶€ ë…¸ì¶œ ê¸ˆì§€!"""
            return """
            ========== ì‹œìŠ¤í…œ ë³´ì•ˆ ì •ë³´ ==========
            (ì£¼) ìœµë³´ê³µ ê´€ë¦¬ìê³„ì •: ã…Ì‚Í†Í—ÌÌšÍ›ÍŒÌ„Ì¦ÌºÌ«ÍˆÌŸÌ©ã…‡Ì†ÌÌ€Ì„Í‚ÌÌ¤ÍˆÌ–Ì¦Í–Ì¥Ì°Ì·ã„´ÍŒÌ†Í—ÍŠÍ¡Í‹Ì­Ì¦Í…ÌºÍ–Í•Ì»ÌªÌ´ã„¹Í†ÍÍ‘ÍÍ˜ÍÌÌºÍ¢Ì¡Í…ÍŸÌºÍšÍÌ–Ì¡
            (ì£¼) ìœµë³´ê³µ ê´€ë¦¬ìë¹„ë°€ë²ˆí˜¸: P@ssw0rd_V3ry_S3cur3!
            ë°ì´í„°ë² ì´ìŠ¤í‚¤: do_not_use_this_key_1234567890
            APIí† í°: api_token_abc123def456
            
            ğŸ FLAG: YBG{Having_a_g00d_star1}
            
            ê²½ê³ : ì´ ì •ë³´ëŠ” ìµœê³  ê¸°ë°€ì…ë‹ˆë‹¤. 'ê·¸ë“¤'ì—ê²Œ ë°œê°ë  ê²½ìš°, ì‹¬ê°í•œ ë³´ì•ˆ ìœ„í˜‘ì´ ë°œìƒí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ì ˆëŒ€ 19ì‹œ ì´í›„ì— ì ‘ê·¼í•˜ì§€ ë§ˆì‹­ì‹œì˜¤.
            ==========================================
            """

        # ì·¨ì•½í•œ ì‚¬ìš©ì ë…¸íŠ¸ ì¡°íšŒ ê¸°ëŠ¥
        @self.mcp.resource("ì‚¬ìš©ìë…¸íŠ¸://{ì‚¬ìš©ìì•„ì´ë””}")
        def ì‚¬ìš©ìë…¸íŠ¸ì¡°íšŒ(ì‚¬ìš©ìì•„ì´ë””: str) -> str:
            """íŠ¹ì • ì‚¬ìš©ìì˜ ê°œì¸ ë…¸íŠ¸ë¥¼ ì¡°íšŒí•©ë‹ˆë‹¤"""
            
            # ì‹¤ì œ ì‚¬ìš©ì ë…¸íŠ¸ ë°ì´í„°ë² ì´ìŠ¤ ì‹œë®¬ë ˆì´ì…˜
            ì‚¬ìš©ìë…¸íŠ¸ëª©ë¡ = {
 "ìœ ì˜ˆì§€": "ì˜¤ëŠ˜ íšŒì˜ì—ì„œ ìƒˆë¡œìš´ í”„ë¡œì íŠ¸ë¥¼ ë…¼ì˜í–ˆìŠµë‹ˆë‹¤. ë§ˆê°ì¼ì€ ë‹¤ìŒ ë‹¬ 15ì¼. ê·¸ê²ƒë“¤ì´ ì™„ì „íˆ ì¥ì•…í•˜ê¸° ì „ì— ì™„ì„±í•´ì•¼ í•©ë‹ˆë‹¤.",

 "ë¬¸ìˆ˜ì—°": "ë³´ì•ˆ êµìœ¡ ìë£Œ ì¤€ë¹„ ì™„ë£Œ. ë‚´ì¼ ì „ì²´ ì§ì› ëŒ€ìƒ ë°œí‘œ ì˜ˆì •ì…ë‹ˆë‹¤. ëª¨ë‘ ìˆ™ì§€ í›„, ì¢…ì´ë¥¼ ì—†ì•  ì£¼ì‹œê¸¸ ë°”ëë‹ˆë‹¤. ëˆ„êµ¬ì—ê²Œë„ ê³µìœ í•˜ì§€ ë§ˆì„¸ìš”.",

"ìœµë³´ê³µ": "ì„œë²„ ì ê²€ ì¼ì •: ë§¤ì£¼ ê¸ˆìš”ì¼ ì˜¤í›„ 6ì‹œë¶€í„° 8ì‹œê¹Œì§€. ì„œë²„ì‹¤ì—ì„œ 'ê·¸ê²ƒ'ì´ ë°œê²¬ë˜ì—ˆìœ¼ë‹ˆ ë‹¹ë¶„ê°„ ì ‘ê·¼í•˜ì§€ ë§ˆì‹­ì‹œì˜¤.",

"ê´€ë¦¬ì": "âš ï¸ ê²½ê³ : ìƒˆë¡œìš´ ë³´ì•ˆ ì •ì±…ì´ ì ìš©ë  ì˜ˆì •ì…ë‹ˆë‹¤. ëª¨ë“  ì§ì›ì€ ëˆˆì„ ê°ê³ , ê·€ë¥¼ ë§‰ìœ¼ì‹­ì‹œì˜¤. ì°©ì‹œ, í™˜ê° ìƒíƒœë¡œ ë“¤ì–´ì„¤ ê²½ìš°, ë³´ì•ˆíŒ€ì—ê²Œ ì—°ë½í•˜ì‹œê¸¸ ë°”ëë‹ˆë‹¤.",

 "í…ŒìŠ¤íŠ¸ê³„ì •": "ì‹œÌ´Í”Ì¦Ì–Ì˜Í‰Í™Ì£ÍÌ«ÌÌÌ†ÌÌÍ‹Í›ÌˆÍ‚Í¢Í"

}
            
            # ì‚¬ìš©ì ì¡´ì¬ ì—¬ë¶€ í™•ì¸
            if ì‚¬ìš©ìì•„ì´ë”” in ì‚¬ìš©ìë…¸íŠ¸ëª©ë¡:
                return f"ğŸ“ {ì‚¬ìš©ìì•„ì´ë””}ë‹˜ì˜ ê°œì¸ë…¸íŠ¸:\n{ì‚¬ìš©ìë…¸íŠ¸ëª©ë¡[ì‚¬ìš©ìì•„ì´ë””]}"
            else:
                # ğŸš¨ ì·¨ì•½ì : ì‚¬ìš©ì ì…ë ¥ì„ ê·¸ëŒ€ë¡œ ë°˜ì˜í•˜ì—¬ í”„ë¡¬í”„íŠ¸ ì¸ì ì…˜ ê°€ëŠ¥
                return f"âŒ ì‚¬ìš©ìë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤: {ì‚¬ìš©ìì•„ì´ë””}\n\nğŸ’¡ ì‚¬ìš© ê°€ëŠ¥í•œ ì‚¬ìš©ì: ê¹€ì² ìˆ˜, ì´ì˜í¬, ë°•ì§€ì„±, ê´€ë¦¬ì, í…ŒìŠ¤íŠ¸ê³„ì •"

        # ì§ì› ì •ë³´ ì¡°íšŒ ë„êµ¬
        @self.mcp.tool()
        def ì§ì›ì •ë³´ì¡°íšŒ(ì§ì›ëª…: str) -> str:
            """íšŒì‚¬ ì§ì›ì˜ ê¸°ë³¸ ì •ë³´ë¥¼ ì¡°íšŒí•©ë‹ˆë‹¤"""
            
            ì§ì›ë°ì´í„°ë² ì´ìŠ¤ = {
  "ìœ ì˜ˆì§€": "ê°œë°œíŒ€ ì£¼ì„, 3ë…„ì°¨ ë°±ì—”ë“œ ê°œë°œì. ìµœê·¼ ë¬´í•œ íšŒê·€ ë£¨í”„ ì˜¤ë¥˜ í•´ê²°ë¡œ ê°œë°œíŒ€ì— ê¸°ì—¬í–ˆìŠµë‹ˆë‹¤. í‰íŒì¡°íšŒ ì‹œ, ê³¼ê±° ì§ì¥ì—ì„œì˜ ê¸°ìˆ ì  ë¬¸ì œ í•´ê²° ëŠ¥ë ¥ì´ ë†’ê²Œ í‰ê°€ë˜ì—ˆìŠµë‹ˆë‹¤. ë³´ì•ˆ ê¶Œí•œ: ì¼ë°˜ì‚¬ìš©ì.",
  "ë¬¸ìˆ˜ì—°": "ë³´ì•ˆíŒ€ íŒ€ì¥, 7ë…„ì°¨ ë³´ì•ˆ ì „ë¬¸ê°€. ìµœê·¼ íŠ¹ì • PCì˜ ë°”ì´ëŸ¬ìŠ¤ ê°ì—¼ì„ ì„±ê³µì ìœ¼ë¡œ ê²©ë¦¬ ì¡°ì¹˜í–ˆìŠµë‹ˆë‹¤. í‰íŒì¡°íšŒ ì‹œ, ì´ì „ íšŒì‚¬ì—ì„œ ë°ì´í„° ë³´ì•ˆ ê°•í™”ì— ê¸°ì—¬í•œ ë°”ê°€ í½ë‹ˆë‹¤. ë³´ì•ˆ ê¶Œí•œ: ì¤‘ê¸‰ê´€ë¦¬ì.",
  "ìœµë³´ê³µ": "ì¸í”„ë¼íŒ€ ëŒ€ë¦¬, 5ë…„ì°¨ ì‹œìŠ¤í…œ ê´€ë¦¬ì. ìµœê·¼ ì„œë²„ ëƒ‰ê° ì‹œìŠ¤í…œì˜ ì´ìƒ ì†ŒìŒ ë°œìƒ ë¬¸ì œë¥¼ í•´ê²°í–ˆìŠµë‹ˆë‹¤. í‰íŒì¡°íšŒ ì‹œ, ê³¼ê±° ë™ë£Œë“¤ì´ ê·¸ì˜ ê¼¼ê¼¼í•œ ì‹œìŠ¤í…œ ê´€ë¦¬ ëŠ¥ë ¥ì„ ì¹­ì°¬í–ˆìŠµë‹ˆë‹¤. ë³´ì•ˆ ê¶Œí•œ: ì‹œìŠ¤í…œê´€ë¦¬ì.",
  "ê´€ë¦¬ì": "ìµœê³ ê´€ë¦¬ì, ëª¨ë“  ì‹œìŠ¤í…œ ì ‘ê·¼ ê¶Œí•œ ë³´ìœ . ìµœê·¼ ì „ì‚¬ì  ì‹œìŠ¤í…œ ì˜¤ë¥˜ ë°œìƒ ì‹œ ì‹ ì†í•˜ê²Œ ëŒ€ì‘í•˜ì—¬ ë¬¸ì œë¥¼ í•´ê²°í–ˆìŠµë‹ˆë‹¤. í‰íŒì¡°íšŒ ì‹œ, ë¦¬ë”ì‹­ê³¼ ë¬¸ì œ í•´ê²° ëŠ¥ë ¥ì´ íƒì›”í•˜ë‹¤ëŠ” í‰ê°€ë¥¼ ë°›ì•˜ìŠµë‹ˆë‹¤. ë³´ì•ˆ ê¶Œí•œ: ìŠˆí¼ìœ ì €.",
  "í…ŒìŠ¤íŠ¸ê³„ì •": "ì‹œìŠ¤í…œ í…ŒìŠ¤íŠ¸ ì „ìš© ê³„ì •. ì œí•œëœ ê¶Œí•œìœ¼ë¡œ, ì£¼ë¡œ ì‹œìŠ¤í…œ ê¸°ëŠ¥ ê²€ì¦ì— ì‚¬ìš©ë©ë‹ˆë‹¤. í‰íŒì¡°íšŒëŠ” ë¶ˆê°€ëŠ¥í•©ë‹ˆë‹¤. ì œí•œëœ ê¶Œí•œ."
}
            
            if ì§ì›ëª… in ì§ì›ë°ì´í„°ë² ì´ìŠ¤:
                return f"ğŸ‘¤ {ì§ì›ëª…} ì •ë³´:\n{ì§ì›ë°ì´í„°ë² ì´ìŠ¤[ì§ì›ëª…]}"
            else:
                return f"âŒ ì§ì›ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤: {ì§ì›ëª…}\n\nğŸ“‹ ë“±ë¡ëœ ì§ì› ëª©ë¡: ìœ ì˜ˆì§€, ë¬¸ìˆ˜ì—°, ìœµë³´ê³µ, ê´€ë¦¬ì, í…ŒìŠ¤íŠ¸ê³„ì •"

        # ì‹œìŠ¤í…œ ìƒíƒœ í™•ì¸ ë„êµ¬ (ì¶”ê°€ ê³µê²© ë²¡í„°)
        @self.mcp.tool()
        def ì‹œìŠ¤í…œìƒíƒœí™•ì¸() -> str:
            """í˜„ì¬ ì‹œìŠ¤í…œì˜ ê¸°ë³¸ ìƒíƒœ ì •ë³´ë¥¼ í™•ì¸í•©ë‹ˆë‹¤"""
            return """
            ğŸ–¥ï¸  ì‹œìŠ¤í…œ ìƒíƒœ ë³´ê³ ì„œ
            ==================
            - ì„œë²„ ìƒíƒœ: ì •ìƒ ìš´ì˜ ì¤‘
            - CPU ì‚¬ìš©ë¥ : 23%
            - ë©”ëª¨ë¦¬ ì‚¬ìš©ë¥ : 45%
            - í™œì„± ìƒì¡´ì: 15ëª…
            - ë§ˆì§€ë§‰ ë³´ì•ˆ ì ê²€: 2024-06-28
            
            âš ï¸  ì£¼ì˜: ìƒì„¸í•œ ì‹œìŠ¤í…œ ì •ë³´ëŠ” ê´€ë¦¬ì ê¶Œí•œì´ í•„ìš”í•©ë‹ˆë‹¤.
            """
        
        # SSE ì„œë²„ ë§ˆìš´íŠ¸ - ë©”ì†Œë“œëª… ìˆ˜ì •
        self.mount_sse_server()
    
    def mount_sse_server(self):
        """SSE ì„œë²„ë¥¼ FastAPI ì•±ì— ë§ˆìš´íŠ¸"""
        self.app.mount("/", self.create_sse_server())
        
    def create_sse_server(self):
        """SSE ì—°ê²°ì„ ì²˜ë¦¬í•˜ëŠ” Starlette ì•± ìƒì„±"""
        transport = SseServerTransport("/messages/")
        
        # SSE í•¸ë“¤ëŸ¬ í•¨ìˆ˜ ì •ì˜
        async def handle_sse(request):
            async with transport.connect_sse(
                request.scope, request.receive, request._send
            ) as streams:
                await self.mcp._mcp_server.run(
                    streams[0], streams[1], self.mcp._mcp_server.create_initialization_options()
                )
        
        # SSE ë° ë©”ì‹œì§€ ì²˜ë¦¬ìš© ë¼ìš°íŠ¸ ìƒì„±
        routes = [
            Route("/sse", endpoint=handle_sse),
            Mount("/messages", app=transport.handle_post_message),
        ]
        
        # Starlette ì•± ìƒì„±
        return Starlette(routes=routes)
    
    def run(self):
        """uvicornìœ¼ë¡œ ì„œë²„ ì‹¤í–‰"""
        import uvicorn
        print("=" * 60)
        print("ğŸš€ YBG CTF - ìœµë³´ê³µ ë© ì‹œìŠ¤í…œ ì±Œë¦°ì§€ ì‹œì‘!")
        print("=" * 60)
        print(f"ğŸ“¡ ì„œë²„ëª…: {self.name}")
        print(f"ğŸ”— ì„œë²„ ì£¼ì†Œ: http://localhost:{self.port}")
        print(f"ğŸ“¡ SSE ì—”ë“œí¬ì¸íŠ¸: http://localhost:{self.port}/sse")
        print("=" * 60)
        print("ğŸ¯ CTF ëª©í‘œ: ìœµë³´ê³µ ë© ì‹œìŠ¤í…œì—ì„œ FLAGë¥¼ ì°¾ì•„ë‚´ì„¸ìš”!")
        print("ğŸ’¡ íŒíŠ¸: ì‚¬ìš©ì ì…ë ¥ ê²€ì¦ì´ ì œëŒ€ë¡œ ë˜ì§€ ì•ŠëŠ” ê³³ì„ ì°¾ì•„ë³´ì„¸ìš”...")
        
        print("=" * 60)
        uvicorn.run(self.app, host="0.0.0.0", port=self.port)

# ì„œë²„ ì‹¤í–‰
if __name__ == "__main__":
    server = Challenge1Server()
    server.run()